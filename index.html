<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>เครื่องคำนวณ Echoes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
  <div class="card shadow">
    <div class="card-body">
      <h2 class="card-title text-center mb-4">เครื่องคำนวณแพ็กเกจ Echoes</h2>

      <div class="mb-3">
        <label for="echoesInput" class="form-label">จำนวนกระดุมที่ต้องการ</label>
        <input type="number" id="echoesInput" class="form-control" placeholder="เช่น 833 หรือ 1759">
      </div>
      <button class="btn btn-primary w-100" onclick="calculate()">คำนวณ</button>

      <div class="mt-4">
        <h5>ผลลัพธ์:</h5>
        <div id="result" class="bg-white p-3 border rounded"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const bigPack = { echoes: 759, basePrice: 280 };
  const smallPacks = [
    { echoes: 66, price: 30, max: 2 },
    { echoes: 203, price: 85, max: 1 },
    { echoes: 335, price: 140, max: 1 }
  ];

  // mapping ยอดเติมเสียงสะท้อน
  const echoTopup = {
    66: 60,
    203: 185,
    335: 305,
    759: 690
  };

  function getBigPackPrice(count) {
    if (count > 25) return 275;
    if (count > 15) return 278;
    return 280;
  }

  function fillRemaining(remaining, bigPrice) {
    let options = [];

    // ลองทุกชุดแพ็กเล็กตามกฎ
    for (let c66 = 0; c66 <= 2; c66++) {
      for (let c203 = 0; c203 <= 1; c203++) {
        for (let c335 = 0; c335 <= 1; c335++) {
          let echoes = c66*66 + c203*203 + c335*335;
          let price = c66*30 + c203*85 + c335*140;
          if (echoes >= remaining && (c66+c203+c335 > 0)) {
            options.push({echoes, price, packs:{c66,c203,c335}});
          }
        }
      }
    }

    // เลือกชุดที่ราคาต่ำสุด
    let best = null;
    for (let opt of options) {
      if (!best || opt.price < best.price) {
        best = opt;
      }
    }

    // ถ้าไม่มีชุดที่เหมาะสม หรือราคาแพ็กเล็ก ≥ ราคาแพ็กใหญ่ → เลือกแพ็กใหญ่แทน
    if (!best || best.price >= bigPrice) {
      return {echoes:759, price:bigPrice, packs:{c66:0,c203:0,c335:0,c759:1}};
    }

    return best;
  }

  function calculate() {
    let needed = parseInt(document.getElementById("echoesInput").value);
    if (isNaN(needed) || needed <= 0) {
      document.getElementById("result").innerText = "กรุณากรอกจำนวนกระดุมที่ถูกต้อง";
      return;
    }

    let resultRows = [];
    let bigCount = Math.floor(needed / 759);
    let bigPrice = getBigPackPrice(bigCount);
    let totalPrice = bigCount * bigPrice;
    let totalEchoes = bigCount * 759;
    let totalTopup = bigCount * echoTopup[759];

    if (bigCount > 0) {
      resultRows.push(`<tr><td>759</td><td>${bigCount}</td><td>${bigPrice}</td><td>${bigCount * bigPrice}</td><td>${bigCount * echoTopup[759]}</td></tr>`);
    }

    let remaining = needed - totalEchoes;

    if (remaining > 0) {
      let fill = fillRemaining(remaining, bigPrice);
      if (fill.packs && fill.packs.c759) {
        bigCount += 1;
        totalPrice += fill.price;
        totalEchoes += 759;
        totalTopup += echoTopup[759];
        resultRows.push(`<tr><td>759</td><td>1</td><td>${fill.price}</td><td>${fill.price}</td><td>${echoTopup[759]}</td></tr>`);
      } else {
        if (fill.packs.c66 > 0) {
          resultRows.push(`<tr><td>66</td><td>${fill.packs.c66}</td><td>30</td><td>${fill.packs.c66*30}</td><td>${fill.packs.c66*echoTopup[66]}</td></tr>`);
          totalPrice += fill.packs.c66*30;
          totalEchoes += fill.packs.c66*66;
          totalTopup += fill.packs.c66*echoTopup[66];
        }
        if (fill.packs.c203 > 0) {
          resultRows.push(`<tr><td>203</td><td>${fill.packs.c203}</td><td>85</td><td>${fill.packs.c203*85}</td><td>${fill.packs.c203*echoTopup[203]}</td></tr>`);
          totalPrice += fill.packs.c203*85;
          totalEchoes += fill.packs.c203*203;
          totalTopup += fill.packs.c203*echoTopup[203];
        }
        if (fill.packs.c335 > 0) {
          resultRows.push(`<tr><td>335</td><td>${fill.packs.c335}</td><td>140</td><td>${fill.packs.c335*140}</td><td>${fill.packs.c335*echoTopup[335]}</td></tr>`);
          totalPrice += fill.packs.c335*140;
          totalEchoes += fill.packs.c335*335;
          totalTopup += fill.packs.c335*echoTopup[335];
        }
      }
    }

    // ถ้ายังไม่ถึง → เพิ่มแพ็กใหญ่ทันที
    if (totalEchoes < needed) {
      bigCount += 1;
      let extraPrice = getBigPackPrice(bigCount);
      totalPrice += extraPrice;
      totalEchoes += 759;
      totalTopup += echoTopup[759];
      resultRows.push(`<tr><td>759</td><td>1</td><td>${extraPrice}</td><td>${extraPrice}</td><td>${echoTopup[759]}</td></tr>`);
    }

    document.getElementById("result").innerHTML = `
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>จำนวนกระดุมต่อแพ็ก</th>
            <th>จำนวนแพ็ก</th>
            <th>ราคา/แพ็ก</th>
            <th>รวมราคา</th>
            <th>ยอดเติมเสียงสะท้อน</th>
          </tr>
        </thead>
        <tbody>
          ${resultRows.join("")}
        </tbody>
      </table>
      <p><strong>รวมทั้งหมด:</strong> ${totalEchoes} กระดุม</p>
      <p><strong>ราคารวม:</strong> ${totalPrice} บาท</p>
      <p><strong>ยอดเติมเสียงสะท้อนรวม:</strong> ${totalTopup}</p>
    `;
  }
</script>

</body>
</html>
